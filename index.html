<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Memory"/>
<meta name="theme-color" content="#0f0f13"/>
<title>Memory Assistant</title>
<link rel="manifest" href="manifest.json"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#0f0f13;font-family:system-ui,sans-serif}
  input[type=time]::-webkit-calendar-picker-indicator{filter:invert(1)}
  textarea,input{caret-color:#6366f1}
  ::-webkit-scrollbar{width:4px}
  ::-webkit-scrollbar-thumb{background:#2a2a38;border-radius:2px}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const CATEGORIES = {
  task:   { label:"Task",   emoji:"‚úÖ", color:"#6366f1" },
  note:   { label:"Note",   emoji:"üìù", color:"#f59e0b" },
  event:  { label:"Event",  emoji:"üìÖ", color:"#10b981" },
  person: { label:"Person", emoji:"üë§", color:"#ec4899" },
};

const BACKEND_URL = "https://memory-app-production-cf54.up.railway.app"; // ‚Üê update after deploy

const TODAY = new Date().toISOString().slice(0,10);
const SYSTEM_PROMPT = `You are a helpful memory assistant. Today's date is ${TODAY}.
The user stores things they want to remember: tasks, notes, events, and people info.
When the user wants to ADD something respond with JSON: {"action":"add","type":"task|note|event|person","title":"...","detail":"...","tags":[],"dueDate":"YYYY-MM-DD or null"}
Extract due dates from natural language (e.g. "by Friday", "next week", "Feb 28") and convert to YYYY-MM-DD format relative to today. If no date mentioned, use null.
When the user wants to RECALL/LIST things respond with JSON: {"action":"recall","filter":"all|task|note|event|person","query":"...","reply":"..."}
When the user wants to DELETE or mark done respond with JSON: {"action":"done","title":"approximate title"}
For general chat respond with JSON: {"action":"chat","reply":"..."}
Always respond with valid JSON only, no markdown fences.`;

const genId = () => Date.now().toString(36) + Math.random().toString(36).slice(2);
const ls = { get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } }, set: (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} } };

// Fire-and-forget backend sync ‚Äî silent fail
function syncToBackend(method, path, body) {
  const url = BACKEND_URL + path;
  const opts = { method, headers: { "Content-Type": "application/json" } };
  if (body) opts.body = JSON.stringify(body);
  fetch(url, opts).catch(() => {});
}

function App() {
  const [memories, setMemories] = useState(() => ls.get("memories_v1") || []);
  const [msgs, setMsgs] = useState([{ role:"assistant", text:"Hi! I'm your memory assistant üß† Tell me something you want to remember, or ask me what you have." }]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [tab, setTab] = useState("chat");
  const [filter, setFilter] = useState("all");
  const [qType, setQType] = useState("task");
  const [qTitle, setQTitle] = useState("");
  const [qDetail, setQDetail] = useState("");
  const [qDueDate, setQDueDate] = useState("");
  const [notifPerm, setNotifPerm] = useState(Notification?.permission || "default");
  const [backendOnline, setBackendOnline] = useState(null); // null=checking, true, false
  const [reminders, setReminders] = useState(() => ls.get("reminders_v1") || [
    { id:"r1", time:"12:00", label:"Midday Check-in", enabled:true },
    { id:"r2", time:"21:00", label:"Evening Review",  enabled:true },
  ]);
  const chatEnd = useRef(null);
  const fired = useRef(new Set());

  useEffect(() => { chatEnd.current?.scrollIntoView({ behavior:"smooth" }); }, [msgs]);

  const saveMem = m => { setMemories(m); ls.set("memories_v1", m); };
  const saveRem = r => { setReminders(r); ls.set("reminders_v1", r); };
  const addMem  = (type, title, detail="", tags=[], dueDate=null) => {
    const m = { id:genId(), type, title, detail, tags, done:false, dueDate: dueDate||null, createdAt:new Date().toISOString() };
    saveMem([m, ...memories]);
    syncToBackend("POST", "/api/memories", m);
    return m;
  };

  // Reminder ticker
  useEffect(() => {
    const t = setInterval(() => {
      if (Notification?.permission !== "granted") return;
      const now = new Date();
      const hhmm = String(now.getHours()).padStart(2,"0") + ":" + String(now.getMinutes()).padStart(2,"0");
      const day  = now.toDateString();
      reminders.forEach(r => {
        if (!r.enabled) return;
        const key = r.id + day;
        if (r.time === hhmm && !fired.current.has(key)) {
          fired.current.add(key);
          const pending = memories.filter(m => m.type==="task" && !m.done).length;
          new Notification("üß† " + r.label, { body: pending > 0 ? `You have ${pending} pending task${pending>1?"s":""}.` : "Time to check your memories!" });
        }
      });
    }, 30000);
    return () => clearInterval(t);
  }, [reminders, memories]);

  // Backend health check (on mount + every 60s)
  useEffect(() => {
    const check = () => fetch(BACKEND_URL + "/health", { signal: AbortSignal.timeout(4000) })
      .then(() => setBackendOnline(true))
      .catch(() => setBackendOnline(false));
    check();
    const t = setInterval(check, 60000);
    return () => clearInterval(t);
  }, []);

  // Focus-poll: when window regains focus, sync done state from backend
  useEffect(() => {
    const onFocus = () => {
      fetch(BACKEND_URL + "/api/memories", { signal: AbortSignal.timeout(5000) })
        .then(r => r.json())
        .then(remote => {
          setMemories(prev => {
            const doneIds = new Set(remote.filter(r => r.done).map(r => r.id));
            const updated = prev.map(m => doneIds.has(m.id) ? { ...m, done: true } : m);
            ls.set("memories_v1", updated);
            return updated;
          });
        })
        .catch(() => {});
    };
    window.addEventListener("focus", onFocus);
    return () => window.removeEventListener("focus", onFocus);
  }, []);

  const [listening, setListening] = React.useState(false);
  const recRef = React.useRef(null);
  const startVoice = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert("Speech recognition not supported. Use Chrome or Safari."); return; }
    if (listening) { recRef.current?.stop(); return; }
    const r = new SR(); r.lang="en-US"; r.interimResults=false;
    r.onstart=()=>setListening(true); r.onend=()=>setListening(false); r.onerror=()=>setListening(false);
    r.onresult=e=>{ const t=e.results[0][0].transcript; setInput(prev=>(prev+" "+t).trim()); };
    recRef.current=r; r.start();
  };

  const send = async () => {
    const text = input.trim(); if (!text || loading) return;
    setInput("");
    const next = [...msgs, { role:"user", text }];
    setMsgs(next); setLoading(true);
    const ctx = memories.length ? "\n\nUser memories (JSON):\n" + JSON.stringify(memories.slice(0,40)) : "";
    try {
      const res  = await fetch("/.netlify/functions/groq-chat", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ model:"llama-3.3-70b-versatile", max_tokens:1000,
          messages:[
            { role:"system", content: SYSTEM_PROMPT + ctx },
            ...next.map(m => ({ role: m.role==="assistant"?"assistant":"user", content:m.text }))
          ]
        })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      const raw  = (data.choices?.[0]?.message?.content || "{}").replace(/```json|```/g,"").trim();
      let p; try { p = JSON.parse(raw); } catch { p = { action:"chat", reply: raw }; }
      let reply = "";
      if (p.action === "add") {
        const m = addMem(p.type, p.title, p.detail||"", p.tags||[], p.dueDate||null);
        reply = `Got it! Saved as a ${CATEGORIES[m.type]?.label}: "${m.title}" ${CATEGORIES[m.type]?.emoji}${m.dueDate ? ` ¬∑ Due ${m.dueDate}` : ""}`;
      } else if (p.action === "recall") {
        const f = p.filter||"all", q=(p.query||"").toLowerCase();
        const res2 = (f==="all"?memories:memories.filter(m=>m.type===f)).filter(m=>!q||m.title.toLowerCase().includes(q)||m.detail?.toLowerCase().includes(q));
        reply = res2.length===0 ? "I couldn't find anything matching that." :
          (p.reply||"Here's what I found:") + "\n\n" + res2.slice(0,10).map(m=>`${CATEGORIES[m.type]?.emoji} **${m.title}**${m.detail?" ‚Äî "+m.detail:""}${m.done?" ‚úì":""}`).join("\n");
      } else if (p.action === "done") {
        const idx = memories.findIndex(m=>m.title.toLowerCase().includes((p.title||"").toLowerCase()));
        if (idx>=0) { const u=[...memories]; u[idx]={...u[idx],done:true}; saveMem(u); syncToBackend("POST","/api/memories",u[idx]); reply=`Marked "${u[idx].title}" as done! ‚úÖ`; }
        else reply = "I couldn't find that task.";
      } else { reply = p.reply || "Try saying 'remember that...' or 'what do I have for...'"; }
      setMsgs(prev=>[...prev,{role:"assistant",text:reply}]);
    } catch { setMsgs(prev=>[...prev,{role:"assistant",text:"Something went wrong. Try again."}]); }
    setLoading(false);
  };

  const renderText = t => t.split("\n").map((line,i)=>{
    const parts = line.split(/\*\*(.*?)\*\*/g);
    return <p key={i} style={{margin:"2px 0"}}>{parts.map((p,j)=>j%2===1?<strong key={j}>{p}</strong>:p)}</p>;
  });

  const filtered = filter==="all" ? memories : memories.filter(m=>m.type===filter);
  const TABS = ["chat","memories","quick-add","reminders"];

  return (
    <div style={{fontFamily:"system-ui",maxWidth:680,margin:"0 auto",height:"100vh",display:"flex",flexDirection:"column",background:"#0f0f13"}}>
      {/* Header */}
      <div style={{padding:"14px 20px",background:"#1a1a24",borderBottom:"1px solid #2a2a38",display:"flex",alignItems:"center",gap:10}}>
        <span style={{fontSize:24}}>üß†</span>
        <div style={{flex:1}}>
          <div style={{color:"#fff",fontWeight:700,fontSize:17}}>Memory Assistant</div>
          <div style={{color:"#888",fontSize:12}}>{memories.length} memories ¬∑ {reminders.filter(r=>r.enabled).length} reminders active</div>
        </div>
        <div style={{textAlign:"right",fontSize:11,lineHeight:1.4}}>
          {backendOnline === null && <span style={{color:"#888"}}>‚óè checking‚Ä¶</span>}
          {backendOnline === true  && <span style={{color:"#10b981"}}>‚óè WhatsApp reminders on</span>}
          {backendOnline === false && <span style={{color:"#ef4444"}}>‚óè Backend offline</span>}
        </div>
      </div>
      {/* Tabs */}
      <div style={{display:"flex",background:"#1a1a24",borderBottom:"1px solid #2a2a38"}}>
        {TABS.map(t=>(
          <button key={t} onClick={()=>setTab(t)} style={{flex:1,padding:"10px 4px",border:"none",background:tab===t?"#6366f1":"transparent",color:tab===t?"#fff":"#888",cursor:"pointer",fontSize:11,fontWeight:600}}>
            {t==="chat"?"üí¨ Chat":t==="memories"?"üóÇ Memories":t==="quick-add"?"‚ö° Quick Add":"üîî Reminders"}
          </button>
        ))}
      </div>

      {/* CHAT */}
      {tab==="chat" && (
        <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{flex:1,overflowY:"auto",padding:16,display:"flex",flexDirection:"column",gap:10}}>
            {msgs.map((m,i)=>(
              <div key={i} style={{display:"flex",justifyContent:m.role==="user"?"flex-end":"flex-start"}}>
                <div style={{maxWidth:"80%",padding:"10px 14px",borderRadius:m.role==="user"?"18px 18px 4px 18px":"18px 18px 18px 4px",background:m.role==="user"?"#6366f1":"#1e1e2e",color:"#e8e8f0",fontSize:14,lineHeight:1.5}}>
                  {renderText(m.text)}
                </div>
              </div>
            ))}
            {loading && <div style={{display:"flex"}}><div style={{padding:"10px 14px",borderRadius:"18px 18px 18px 4px",background:"#1e1e2e",color:"#888",fontSize:14}}>Thinking...</div></div>}
            <div ref={chatEnd}/>
          </div>
          <div style={{padding:12,background:"#1a1a24",borderTop:"1px solid #2a2a38",display:"flex",gap:8}}>
            <textarea value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}}}
              placeholder="Type or tap üé§ to speak..." rows={2}
              style={{flex:1,padding:"10px 14px",borderRadius:12,border:"1px solid #2a2a38",background:"#0f0f13",color:"#e8e8f0",fontSize:14,resize:"none",outline:"none",lineHeight:1.5}}/>
            <button onClick={startVoice} style={{padding:"0 14px",borderRadius:12,border:"none",fontSize:18,cursor:"pointer",background:listening?"#ec4899":"#1e1e2e",color:"#fff"}}>üé§</button>
            <button onClick={send} disabled={loading||!input.trim()} style={{padding:"0 18px",borderRadius:12,border:"none",background:"#6366f1",color:"#fff",fontWeight:700,cursor:"pointer",opacity:loading||!input.trim()?0.5:1,fontSize:18}}>‚Üë</button>
          </div>
        </div>
      )}

      {/* MEMORIES */}
      {tab==="memories" && (
        <div style={{flex:1,overflow:"hidden",display:"flex",flexDirection:"column"}}>
          <div style={{padding:"10px 12px",background:"#1a1a24",borderBottom:"1px solid #2a2a38",display:"flex",gap:6,flexWrap:"wrap"}}>
            {["all",...Object.keys(CATEGORIES)].map(f=>(
              <button key={f} onClick={()=>setFilter(f)} style={{padding:"4px 12px",borderRadius:20,border:"1px solid "+(filter===f?"#6366f1":"#2a2a38"),background:filter===f?"#6366f1":"transparent",color:filter===f?"#fff":"#888",cursor:"pointer",fontSize:12,fontWeight:600}}>
                {f==="all"?`All (${memories.length})`:`${CATEGORIES[f].emoji} ${CATEGORIES[f].label}`}
              </button>
            ))}
          </div>
          <div style={{flex:1,overflowY:"auto",padding:12,display:"flex",flexDirection:"column",gap:8}}>
            {filtered.length===0 && <div style={{textAlign:"center",color:"#555",marginTop:40}}>No memories yet.</div>}
            {filtered.map(m=>{
              const cat=CATEGORIES[m.type]||CATEGORIES.note;
              return (
                <div key={m.id} style={{background:"#1e1e2e",borderRadius:12,padding:"12px 14px",borderLeft:`3px solid ${cat.color}`,opacity:m.done?0.5:1,display:"flex",gap:10,alignItems:"flex-start"}}>
                  <span style={{fontSize:18}}>{cat.emoji}</span>
                  <div style={{flex:1}}>
                    <div style={{color:"#e8e8f0",fontWeight:600,fontSize:14,textDecoration:m.done?"line-through":"none"}}>{m.title}</div>
                    {m.detail && <div style={{color:"#888",fontSize:12,marginTop:3}}>{m.detail}</div>}
                    <div style={{color:"#555",fontSize:11,marginTop:4}}>
                    {new Date(m.createdAt).toLocaleDateString()}
                    {m.dueDate && <span style={{color:"#6366f1",marginLeft:8}}>Due {m.dueDate}</span>}
                  </div>
                  </div>
                  <div style={{display:"flex",gap:6}}>
                    {m.type==="task" && <button onClick={()=>{const u=memories.map(x=>x.id===m.id?{...x,done:!x.done}:x);saveMem(u);syncToBackend("POST","/api/memories",u.find(x=>x.id===m.id));}} style={{background:m.done?"#10b981":"transparent",border:"1px solid #2a2a38",color:m.done?"#fff":"#888",borderRadius:6,padding:"2px 8px",cursor:"pointer",fontSize:12}}>{m.done?"‚úì":"‚óã"}</button>}
                    <button onClick={()=>{saveMem(memories.filter(x=>x.id!==m.id));syncToBackend("DELETE","/api/memories/"+m.id);}} style={{background:"transparent",border:"1px solid #2a2a38",color:"#666",borderRadius:6,padding:"2px 8px",cursor:"pointer",fontSize:12}}>üóë</button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* QUICK ADD */}
      {tab==="quick-add" && (
        <div style={{flex:1,overflow:"auto",padding:20}}>
          <div style={{marginBottom:16}}>
            <div style={{color:"#888",fontSize:13,marginBottom:8}}>Category</div>
            <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
              {Object.entries(CATEGORIES).map(([k,v])=>(
                <button key={k} onClick={()=>setQType(k)} style={{padding:"8px 16px",borderRadius:20,border:"2px solid "+(qType===k?v.color:"#2a2a38"),background:qType===k?v.color+"22":"transparent",color:qType===k?v.color:"#888",cursor:"pointer",fontSize:13,fontWeight:600}}>
                  {v.emoji} {v.label}
                </button>
              ))}
            </div>
          </div>
          <div style={{marginBottom:12}}>
            <div style={{color:"#888",fontSize:13,marginBottom:6}}>Title *</div>
            <input value={qTitle} onChange={e=>setQTitle(e.target.value)} placeholder="What do you want to remember?"
              onKeyDown={e=>e.key==="Enter"&&qTitle.trim()&&(addMem(qType,qTitle.trim(),qDetail.trim(),[],qDueDate||null),setQTitle(""),setQDetail(""),setQDueDate(""))}
              style={{width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid #2a2a38",background:"#1e1e2e",color:"#e8e8f0",fontSize:14,outline:"none"}}/>
          </div>
          <div style={{marginBottom:12}}>
            <div style={{color:"#888",fontSize:13,marginBottom:6}}>Due Date (optional)</div>
            <input type="date" value={qDueDate} onChange={e=>setQDueDate(e.target.value)}
              style={{width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid #2a2a38",background:"#1e1e2e",color:"#e8e8f0",fontSize:14,outline:"none",colorScheme:"dark"}}/>
          </div>
          <div style={{marginBottom:20}}>
            <div style={{color:"#888",fontSize:13,marginBottom:6}}>Details (optional)</div>
            <textarea value={qDetail} onChange={e=>setQDetail(e.target.value)} placeholder="Any extra context..." rows={3}
              style={{width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid #2a2a38",background:"#1e1e2e",color:"#e8e8f0",fontSize:14,outline:"none",resize:"vertical"}}/>
          </div>
          <button disabled={!qTitle.trim()} onClick={()=>{addMem(qType,qTitle.trim(),qDetail.trim(),[],qDueDate||null);setQTitle("");setQDetail("");setQDueDate("");}}
            style={{width:"100%",padding:"12px",borderRadius:12,border:"none",background:qTitle.trim()?"#6366f1":"#2a2a38",color:"#fff",fontWeight:700,fontSize:15,cursor:qTitle.trim()?"pointer":"not-allowed"}}>
            Save Memory ‚ö°
          </button>
        </div>
      )}

      {/* REMINDERS */}
      {tab==="reminders" && (
        <div style={{flex:1,overflow:"auto",padding:20}}>
          {notifPerm!=="granted" && (
            <div style={{background:"#1e1e2e",border:"1px solid #f59e0b",borderRadius:12,padding:"14px 16px",marginBottom:20}}>
              <div style={{color:"#f59e0b",fontWeight:700,marginBottom:6}}>üîî Notifications not enabled</div>
              <div style={{color:"#888",fontSize:13,marginBottom:12}}>Enable so reminders reach you.</div>
              <button onClick={async()=>{const p=await Notification.requestPermission();setNotifPerm(p);}} style={{background:"#f59e0b",color:"#000",border:"none",borderRadius:8,padding:"8px 16px",fontWeight:700,cursor:"pointer",fontSize:13}}>Enable Notifications</button>
            </div>
          )}
          {notifPerm==="granted" && <div style={{background:"#10b98122",border:"1px solid #10b981",borderRadius:12,padding:"10px 14px",marginBottom:20,color:"#10b981",fontSize:13,fontWeight:600}}>‚úÖ Notifications enabled</div>}
          <div style={{color:"#e8e8f0",fontWeight:700,marginBottom:14,fontSize:15}}>Your Reminders</div>
          <div style={{display:"flex",flexDirection:"column",gap:10,marginBottom:20}}>
            {reminders.map(r=>(
              <div key={r.id} style={{background:"#1e1e2e",borderRadius:12,padding:"14px 16px",display:"flex",alignItems:"center",gap:12,borderLeft:`3px solid ${r.enabled?"#6366f1":"#333"}`}}>
                <div style={{flex:1}}>
                  <input value={r.label} onChange={e=>saveRem(reminders.map(x=>x.id===r.id?{...x,label:e.target.value}:x))}
                    style={{background:"transparent",border:"none",color:"#e8e8f0",fontWeight:600,fontSize:14,outline:"none",width:"100%"}}/>
                  <div style={{marginTop:6}}>
                    <input type="time" value={r.time} onChange={e=>saveRem(reminders.map(x=>x.id===r.id?{...x,time:e.target.value}:x))}
                      style={{background:"#0f0f13",border:"1px solid #2a2a38",color:"#6366f1",borderRadius:6,padding:"4px 8px",fontSize:14,fontWeight:700,outline:"none"}}/>
                  </div>
                </div>
                <div onClick={()=>saveRem(reminders.map(x=>x.id===r.id?{...x,enabled:!x.enabled}:x))} style={{width:44,height:24,borderRadius:12,background:r.enabled?"#6366f1":"#333",position:"relative",transition:"background 0.2s",cursor:"pointer"}}>
                  <div style={{position:"absolute",top:3,left:r.enabled?22:3,width:18,height:18,borderRadius:9,background:"#fff",transition:"left 0.2s"}}/>
                </div>
                <button onClick={()=>saveRem(reminders.filter(x=>x.id!==r.id))} style={{background:"transparent",border:"1px solid #2a2a38",color:"#666",borderRadius:6,padding:"4px 10px",cursor:"pointer",fontSize:14}}>üóë</button>
              </div>
            ))}
          </div>
          <button onClick={()=>saveRem([...reminders,{id:genId(),time:"08:00",label:"Reminder",enabled:true}])}
            style={{width:"100%",padding:"11px",borderRadius:12,border:"2px dashed #2a2a38",background:"transparent",color:"#888",fontWeight:600,cursor:"pointer",fontSize:14}}>
            + Add Reminder
          </button>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>